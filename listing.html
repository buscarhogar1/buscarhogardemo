<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buscar Hogar ‚Äì Ficha</title>

    <style>
      :root{
        --bg:#ffffff;
        --text:#111;
        --muted:#6b7280;
        --border:#e6e7eb;
        --chip:#f3f4f6;
        --card:#ffffff;
        --shadow:0 10px 30px rgba(0,0,0,.08);
        --radius:14px;
      }

      html,body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--text); background:var(--bg);}
      .wrap{max-width:1180px; margin:0 auto; padding:14px 16px 40px;}

      /* Top row */
      .topRow{display:flex; align-items:center; justify-content:flex-start; gap:12px; margin-bottom:10px;}
      .back{display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); border:1px solid var(--border); padding:9px 12px; border-radius:12px; background:#fff;}

      /* Breadcrumb */
      .crumbs{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; margin:10px 0 12px;}
      .crumbItem{color:#1f6feb; text-decoration:none;}
      .crumbText{color:var(--muted);}
      .sep{color:#c4c7cf;}

      /* Media block (1 big + 4 small) */
      .mediaBlock{
        position:relative;
        border-radius:18px;
        overflow:hidden;
        background:#f2f3f5;
        border:1px solid var(--border);
      }

      .mediaGrid{
        display:grid;
        grid-template-columns: 2fr 1fr;
        gap:6px;
        padding:6px;
        background:#fff;
      }

      .mediaBig{
        border-radius:14px;
        background:linear-gradient(135deg,#f0f1f3,#ffffff);
        min-height:420px;
        border:1px solid var(--border);
        display:grid;
        place-items:center;
        color:#9aa1aa;
        user-select:none;
      }

      .mediaSmallGrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:6px;
      }

      .mediaSmall{
        border-radius:14px;
        background:linear-gradient(135deg,#f0f1f3,#ffffff);
        min-height:206px;
        border:1px solid var(--border);
        display:grid;
        place-items:center;
        color:#9aa1aa;
        user-select:none;
        position:relative;
      }

      /* Overlay actions on top-right of media block */
      .mediaActions{
        position:absolute;
        right:16px;
        top:16px;
        display:flex;
        gap:10px;
        z-index:5;
      }
      .actionBtn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        height:44px;
        padding:0 14px;
        border-radius:12px;
        border:1px solid var(--border);
        background:#fff;
        box-shadow:0 10px 30px rgba(0,0,0,.10);
        cursor:pointer;
        font-size:14px;
      }
      .actionBtn:active{transform:translateY(1px);}
      .actionIcon{width:44px; padding:0;}

      /* Media tabs row */
      .mediaTabs{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:12px;
        border-bottom:1px solid var(--border);
        padding:12px 6px 12px;
        margin-bottom:18px;
      }
      .tabsLeft{display:flex; gap:18px; flex-wrap:wrap; align-items:center;}
      .tabBtn{
        display:inline-flex;
        align-items:center;
        gap:8px;
        color:#111;
        font-size:14px;
        padding:6px 8px;
        border-radius:10px;
        border:0;
        background:transparent;
        cursor:pointer;
      }
      .tabBtn:hover{background:#f6f7f9;}
      .tabCount{color:var(--muted);}
      .tabsRight .tabBtn{border:1px solid var(--border); background:#fff;}

      /* Main content grid */
      .contentGrid{
        display:grid;
        grid-template-columns: 2fr 1fr;
        gap:20px;
        align-items:start;
      }

      .mainLeft{min-width:0;}
      .sideRight{min-width:0;}

      /* Left summary block */
      .badge{
        display:inline-flex;
        align-items:center;
        height:22px;
        padding:0 8px;
        border-radius:6px;
        background:#ffefc6;
        border:1px solid #ffe39a;
        color:#8a5b00;
        font-size:12px;
        margin-bottom:10px;
      }

      .title{font-size:34px; line-height:1.08; margin:0 0 6px; font-weight:900; letter-spacing:-0.2px;}
      .metaLine{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:14px; margin-bottom:10px;}
      .metaLine .linkish{color:#1f6feb; text-decoration:none;}

      .priceRow{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; margin:12px 0 10px;}
      .price{font-size:34px; font-weight:900; margin:0;}
      .priceNoteBtn{
        color:var(--muted);
        font-size:14px;
        border:0;
        background:transparent;
        padding:0;
        cursor:pointer;
      }
      .priceNoteBtn:hover{text-decoration:underline;}

      .factsRow{
        display:flex;
        gap:18px;
        flex-wrap:wrap;
        align-items:center;
        margin-top:10px;
        color:#111;
        font-size:15px;
      }
      .fact{display:inline-flex; align-items:center; gap:8px;}
      .factIcon{
        width:18px; height:18px;
        border:1px solid var(--border);
        border-radius:4px;
        background:#fff;
      }
      .factMuted{color:var(--muted);}

      /* Right cards */
      .sideCard{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:16px;
        box-shadow:var(--shadow);
        padding:14px;
      }
      .sideSticky{position:sticky; top:14px; display:grid; gap:14px;}

      .sideTitle{color:var(--muted); font-size:13px; margin:0 0 10px;}
      .kv{display:grid; gap:10px;}
      .kvLine{display:grid; grid-template-columns: 92px 1fr; gap:10px;}
      .k{color:var(--muted); font-size:13px;}
      .v{font-size:14px;}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; color:var(--muted); word-break:break-all;}

      .mapMock{
        height:120px;
        border:1px solid var(--border);
        border-radius:12px;
        background:linear-gradient(135deg,#f0f1f3,#ffffff);
        display:grid;
        place-items:center;
        color:#9aa1aa;
        font-size:13px;
        user-select:none;
      }

      /* Responsive */
      @media (max-width: 980px){
        .mediaGrid{grid-template-columns:1fr; }
        .mediaSmallGrid{grid-template-columns:1fr 1fr;}
        .mediaBig{min-height:300px;}
        .mediaSmall{min-height:160px;}
        .contentGrid{grid-template-columns:1fr;}
        .sideSticky{position:static;}
      }
      @media (max-width: 560px){
        .mediaSmallGrid{grid-template-columns:1fr;}
      }
    </style>
  </head>

  <body>
    <div class="wrap">

      <div class="topRow">
        <a class="back" href="./">Volver al mapa</a>
      </div>

      <div class="crumbs" id="crumbs">
        <span>üè†</span>
        <span class="sep">/</span>
        <span class="crumbItem" id="crumbCity">Ciudad</span>
        <span class="sep">/</span>
        <span class="crumbItem" id="crumbNeighborhood">Barrio</span>
        <span class="sep">/</span>
        <span class="crumbText" id="crumbAddress">Direcci√≥n</span>
      </div>

      <div class="mediaBlock">
        <div class="mediaActions">
          <button class="actionBtn actionIcon" id="shareBtn" type="button" title="Compartir">‚§¥</button>
          <button class="actionBtn" id="saveBtn" type="button" title="Guardar">‚ô° Guardar</button>
        </div>

        <div class="mediaGrid">
          <div class="mediaBig">Foto principal (pendiente)</div>
          <div class="mediaSmallGrid">
            <div class="mediaSmall">Foto</div>
            <div class="mediaSmall">V√≠deo</div>
            <div class="mediaSmall">Foto</div>
            <div class="mediaSmall">Foto</div>
          </div>
        </div>
      </div>

      <div class="mediaTabs">
        <div class="tabsLeft">
          <button class="tabBtn" type="button"><span class="factIcon"></span> Foto‚Äôs <span class="tabCount" id="photosCount">0</span></button>
          <button class="tabBtn" type="button"><span class="factIcon"></span> Plano <span class="tabCount" id="floorCount">0</span></button>
          <button class="tabBtn" type="button"><span class="factIcon"></span> 360¬∞ <span class="tabCount" id="panoCount">0</span></button>
          <button class="tabBtn" type="button"><span class="factIcon"></span> Video</button>
        </div>
        <div class="tabsRight">
          <button class="tabBtn" type="button"><span class="factIcon"></span> Todo el media</button>
        </div>
      </div>

      <div class="contentGrid">
        <div class="mainLeft">
          <div class="badge" id="badge" style="display:none;">Nuevo</div>

          <h1 class="title" id="title">Direcci√≥n</h1>

          <div class="metaLine">
            <span id="metaPostal">‚Äî</span>
            <span class="sep">‚Ä¢</span>
            <span id="metaCity">‚Äî</span>
            <span class="sep">‚Ä¢</span>
            <span class="linkish" id="metaNeighborhood">Barrio</span>
          </div>

          <div class="priceRow">
            <p class="price" id="price">‚Äî</p>
            <button class="priceNoteBtn" type="button" id="monthlyLink">¬øCu√°nto pagar√© al mes?</button>
          </div>

          <div class="factsRow" id="factsRow"></div>
        </div>

        <div class="sideRight">
          <div class="sideSticky">
            <div class="sideCard">
              <div class="mapMock">Mapa (pendiente)</div>
            </div>

            <div class="sideCard">
              <p class="sideTitle">Agencia</p>
              <div class="kv">
                <div class="kvLine">
                  <div class="k">Nombre</div>
                  <div class="v" id="agency">‚Äî</div>
                </div>
                <div class="kvLine">
                  <div class="k">Publicado</div>
                  <div class="v" id="listedAt">‚Äî</div>
                </div>
                <div class="kvLine">
                  <div class="k">Tipo</div>
                  <div class="v" id="ptype">‚Äî</div>
                </div>
                <div class="kvLine">
                  <div class="k">ID</div>
                  <div class="v mono" id="id">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="sideCard" style="display:none;">
              <p class="sideTitle">Notas</p>
              <div class="k">Esta ficha es MVP. Las fotos y el plano se conectar√°n cuando el backend exponga esos campos.</div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <script>
      const SUPABASE_URL = "https://dpusnylssfjnksbieimj.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_tSSgJcWWRfEe2uob7SFYgw_AqcBL7KK";
      const VIEW_DETAIL = "listing_detail_public";

      const titleEl = document.getElementById("title");
      const priceEl = document.getElementById("price");
      const agencyEl = document.getElementById("agency");
      const listedAtEl = document.getElementById("listedAt");
      const idEl = document.getElementById("id");
      const ptypeEl = document.getElementById("ptype");

      const metaPostalEl = document.getElementById("metaPostal");
      const metaCityEl = document.getElementById("metaCity");
      const metaNeighborhoodEl = document.getElementById("metaNeighborhood");

      const crumbsCityEl = document.getElementById("crumbCity");
      const crumbsNeighborhoodEl = document.getElementById("crumbNeighborhood");
      const crumbsAddressEl = document.getElementById("crumbAddress");

      const factsRowEl = document.getElementById("factsRow");

      const shareBtn = document.getElementById("shareBtn");
      const saveBtn = document.getElementById("saveBtn");
      const monthlyBtn = document.getElementById("monthlyLink");

      function euro(n) {
        try {
          return new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }).format(n);
        } catch {
          return `${n} EUR`;
        }
      }

      function fmtDate(s) {
        if (!s) return "‚Äî";
        try {
          const d = new Date(s);
          if (isNaN(d.getTime())) return String(s);
          return d.toLocaleDateString("es-ES");
        } catch {
          return String(s);
        }
      }

      function getParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      function addFact(text, muted=false) {
        const wrap = document.createElement("div");
        wrap.className = "fact";
        const icon = document.createElement("span");
        icon.className = "factIcon";
        const t = document.createElement("span");
        t.textContent = text;
        if (muted) t.className = "factMuted";
        wrap.appendChild(icon);
        wrap.appendChild(t);
        factsRowEl.appendChild(wrap);
      }

      async function fetchDetail(listingId) {
        const url =
          `${SUPABASE_URL}/rest/v1/${VIEW_DETAIL}` +
          `?select=listing_id,price_eur,listed_at,agency_name,property_type,useful_area_m2,built_year,city,neighborhood,address_display,postcode,province` +
          `&listing_id=eq.${encodeURIComponent(listingId)}&limit=1`;

        const res = await fetch(url, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: \`Bearer ${SUPABASE_ANON_KEY}\`
          }
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt);
        }

        const data = await res.json();
        return data[0] || null;
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch {
          return false;
        }
      }

      shareBtn.addEventListener("click", async () => {
        const ok = await copyToClipboard(window.location.href);
        if (ok) return;
        // fallback
        window.prompt("Copia el enlace:", window.location.href);
      });

      let saved = false;
      saveBtn.addEventListener("click", () => {
        saved = !saved;
        saveBtn.textContent = saved ? "‚ô• Guardado" : "‚ô° Guardar";
      });

      monthlyBtn.addEventListener("click", () => {
        alert("MVP: aqu√≠ luego conectaremos calculadora / info financiera.");
      });

      (async () => {
        const listingId = getParam("id");
        if (!listingId) {
          titleEl.textContent = "Ficha no disponible (falta ?id=...)";
          return;
        }

        try {
          const row = await fetchDetail(listingId);

          if (!row) {
            titleEl.textContent = "Ficha no encontrada";
            idEl.textContent = listingId;
            return;
          }

          crumbsCityEl.textContent = row.city || "Ciudad";
          crumbsNeighborhoodEl.textContent = row.neighborhood || "Barrio";
          crumbsAddressEl.textContent = row.address_display || "Direcci√≥n";

          titleEl.textContent = row.address_display || "Direcci√≥n";
          metaPostalEl.textContent = row.postcode || "‚Äî";
          metaCityEl.textContent = row.city || "‚Äî";
          metaNeighborhoodEl.textContent = row.neighborhood || "‚Äî";

          priceEl.textContent = row.price_eur != null ? euro(row.price_eur) : "‚Äî";

          agencyEl.textContent = row.agency_name || "‚Äî";
          listedAtEl.textContent = fmtDate(row.listed_at);
          ptypeEl.textContent = row.property_type || "‚Äî";
          idEl.textContent = row.listing_id || listingId;

          factsRowEl.innerHTML = "";
          if (row.useful_area_m2 != null) addFact(\`\${row.useful_area_m2} m¬≤\`);
          if (row.built_year != null) addFact(\`A√±o \${row.built_year}\`, true);
          if (row.province) addFact(row.province, true);

        } catch (e) {
          const msg = (e && e.message) ? e.message : String(e);
          titleEl.textContent = "Error cargando ficha";
          console.error(e);
          alert(msg);
        }
      })();
    </script>
  </body>
</html>




