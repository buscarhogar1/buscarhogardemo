<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buscar Hogar – Demo Mapa</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      html, body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: #fff;
      }

      #topbar {
        height: 56px;
        display: flex;
        align-items: center;
        padding: 0 16px;
        border-bottom: 1px solid #eee;
        gap: 12px;
        background: #fff;
      }

      #cityInput {
        width: 260px;
        height: 36px;
        padding: 0 10px;
      }

      #searchBtn {
        height: 36px;
        padding: 0 12px;
        cursor: pointer;
      }

      #status {
        color: #555;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #map {
        height: calc(100% - 56px);
      }

      /* Marker dot */
      .dot {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        background: #ffb100;
        border: 3px solid #ffffff;
        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }

      .dot:hover { transform: scale(1.15); }

      .dot.active {
        background: #1a73e8;
        border-color: #0b3d91;
        transform: scale(1.15);
      }

      /* ===== Card inferior estilo funda ===== */
      .card {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 14px;
        width: min(680px, calc(100% - 24px));
        background: #fff;
        border: 1px solid rgba(0,0,0,0.10);
        border-radius: 12px;
        box-shadow: 0 18px 45px rgba(0,0,0,0.18);
        z-index: 9999;
        overflow: hidden;
      }

      .hidden { display: none; }

      .cardInner {
        display: grid;
        grid-template-columns: 122px 1fr;
        gap: 12px;
        padding: 12px;
        align-items: center;
      }

      .thumb {
        width: 122px;
        height: 92px;
        border-radius: 10px;
        background: #f1f2f4;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(0,0,0,0.06);
      }

      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .thumbPlaceholder {
        width: 100%;
        height: 100%;
        display: grid;
        place-items: center;
        color: #9aa1aa;
        font-size: 12px;
      }

      .cardMain {
        min-width: 0;
      }

      .cardTopRow {
        display: flex;
        align-items: start;
        justify-content: space-between;
        gap: 10px;
      }

      .cardAddress {
        color: #111;
        text-decoration: none;
        font-weight: 700;
        font-size: 15px;
        line-height: 1.15;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .cardAddress:hover { text-decoration: underline; }

      .cardClose {
        flex: 0 0 auto;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.10);
        background: #fff;
        cursor: pointer;
        font-size: 20px;
        line-height: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .cardPrice {
        margin-top: 6px;
        font-size: 18px;
        font-weight: 900;
        color: #111;
      }

      .cardFacts {
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
        color: #111;
        font-size: 14px;
      }

      .fact {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #111;
      }

      .fact svg {
        width: 18px;
        height: 18px;
        color: rgba(0,0,0,0.65);
      }

      .energyPill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        padding: 0 7px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.12);
        font-weight: 800;
        font-size: 12px;
        line-height: 1;
        background: #fff;
      }

      .cardMetaLine {
        margin-top: 4px;
        color: #6b7280;
        font-size: 12.5px;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      @media (max-width: 420px) {
        .cardInner { grid-template-columns: 104px 1fr; }
        .thumb { width: 104px; height: 80px; }
        .cardPrice { font-size: 17px; }
      }

      /* Leaflet: retocar un poco zoom controls para estilo "mapa comercial" */
      .leaflet-control-zoom a {
        width: 34px;
        height: 34px;
        line-height: 34px;
        border-radius: 10px;
      }
      .leaflet-bar a, .leaflet-bar a:hover {
        border-bottom: 1px solid rgba(0,0,0,0.08);
      }
    </style>
  </head>

  <body>
    <div id="topbar">
      <input id="cityInput" value="Murcia" placeholder="Escribe ciudad" />
      <button id="searchBtn">Buscar</button>
      <div id="status"></div>
    </div>

    <div id="map"></div>

    <!-- Tarjeta inferior -->
    <div id="card" class="card hidden">
      <div class="cardInner">
        <div class="thumb" id="thumb">
          <div class="thumbPlaceholder">Foto</div>
        </div>

        <div class="cardMain">
          <div class="cardTopRow">
            <a class="cardAddress" id="cardAddress" href="#">Dirección</a>
            <button id="cardClose" class="cardClose" aria-label="Cerrar">×</button>
          </div>

          <div class="cardPrice" id="cardPrice">—</div>

          <div class="cardFacts" id="cardFacts"></div>
          <div class="cardMetaLine" id="cardMeta">—</div>
        </div>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      const SUPABASE_URL = "https://dpusnylssfjnksbieimj.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_tSSgJcWWRfEe2uob7SFYgw_AqcBL7KK";
      const VIEW_MAP_POINTS = "listings_map_points";

      const DEFAULT_CENTER = [37.9838, -1.1280];
      const DEFAULT_ZOOM = 13;

      const statusEl = document.getElementById("status");
      const cityInput = document.getElementById("cityInput");
      const searchBtn = document.getElementById("searchBtn");

      // Card elements
      const cardEl = document.getElementById("card");
      const cardCloseBtn = document.getElementById("cardClose");
      const thumbEl = document.getElementById("thumb");
      const cardAddressEl = document.getElementById("cardAddress");
      const cardPriceEl = document.getElementById("cardPrice");
      const cardFactsEl = document.getElementById("cardFacts");
      const cardMetaEl = document.getElementById("cardMeta");

      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      function euro(n) {
        try {
          return new Intl.NumberFormat("es-ES", {
            style: "currency",
            currency: "EUR",
            maximumFractionDigits: 0
          }).format(n);
        } catch {
          return `${n} EUR`;
        }
      }

      function closeCard() {
        cardEl.classList.add("hidden");
      }

      cardCloseBtn.addEventListener("click", closeCard);

      function setThumb(url) {
        thumbEl.innerHTML = "";
        if (!url) {
          const ph = document.createElement("div");
          ph.className = "thumbPlaceholder";
          ph.textContent = "Foto";
          thumbEl.appendChild(ph);
          return;
        }

        const img = document.createElement("img");
        img.src = url;
        img.alt = "";
        img.loading = "lazy";
        img.onerror = () => {
          thumbEl.innerHTML = "";
          const ph = document.createElement("div");
          ph.className = "thumbPlaceholder";
          ph.textContent = "Foto";
          thumbEl.appendChild(ph);
        };
        thumbEl.appendChild(img);
      }

      function iconArea() {
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M4 10h16"/><path d="M10 10v10"/></svg>';
      }
      function iconBed() {
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18v10H3z"/><path d="M7 7V5h10v2"/><path d="M3 17v2"/><path d="M21 17v2"/></svg>';
      }
      function iconBolt() {
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/></svg>';
      }

      function addFact(htmlIcon, text, extraHtml="") {
        const w = document.createElement("div");
        w.className = "fact";
        w.innerHTML = htmlIcon + "<span>" + text + "</span>" + extraHtml;
        cardFactsEl.appendChild(w);
      }

      function openCardForPoint(p) {
        const addressText =
          p.address_display || p.address || p.display_address || p.street_address || "Dirección";

        const href = `listing.html?id=${encodeURIComponent(p.listing_id)}`;
        cardAddressEl.textContent = addressText;
        cardAddressEl.href = href;

        cardPriceEl.textContent = (p.price_eur != null) ? euro(p.price_eur) : "—";

        const photoUrl = p.main_photo_url || p.photo_url || p.cover_url || null;
        setThumb(photoUrl);

        cardFactsEl.innerHTML = "";

        if (p.useful_area_m2 != null) addFact(iconArea(), `${p.useful_area_m2} m²`);
        else addFact(iconArea(), "— m²");

        const rooms = (p.rooms != null) ? p.rooms : (p.bedrooms != null ? p.bedrooms : null);
        if (rooms != null) addFact(iconBed(), `${rooms}`);
        else addFact(iconBed(), "—");

        const label = (p.energy_label != null) ? String(p.energy_label).toUpperCase() : null;
        if (label) addFact(iconBolt(), "", ` <span class="energyPill">${label}</span>`);
        else addFact(iconBolt(), "", ' <span class="energyPill">—</span>');

        const metaParts = [];
        if (p.neighborhood) metaParts.push(p.neighborhood);
        if (p.city) metaParts.push(p.city);
        cardMetaEl.textContent = metaParts.length ? metaParts.join(" · ") : "—";

        cardEl.classList.remove("hidden");
      }

      // Map init
      let map = L.map("map").setView(DEFAULT_CENTER, DEFAULT_ZOOM);

      /*
        Mapa "lo más parecido posible" a Google sin usar Google:
        - CARTO Voyager (sin key) da un look muy "comercial" y limpio.
      */
      L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap &copy; CARTO"
      }).addTo(map);

      let markersLayer = L.layerGroup().addTo(map);
      let activeMarker = null;

      function clearMarkers() {
        markersLayer.clearLayers();
        activeMarker = null;
      }

      function addPoint(p) {
        if (p.lat == null || p.lng == null) return;

        const el = document.createElement("div");
        el.className = "dot";

        const icon = L.divIcon({
          className: "",
          html: el,
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });

        const m = L.marker([p.lat, p.lng], { icon }).addTo(markersLayer);

        m.on("click", () => {
          if (activeMarker && activeMarker._icon) {
            activeMarker._icon.querySelector(".dot")?.classList.remove("active");
          }
          activeMarker = m;
          m._icon.querySelector(".dot")?.classList.add("active");

          openCardForPoint(p);
        });
      }

      async function fetchWithSelect(bounds, selectStr) {
        const params = new URLSearchParams();
        params.set("select", selectStr);

        params.set("lat", `gte.${bounds.south}`);
        params.append("lat", `lte.${bounds.north}`);
        params.set("lng", `gte.${bounds.west}`);
        params.append("lng", `lte.${bounds.east}`);

        const url = `${SUPABASE_URL}/rest/v1/${VIEW_MAP_POINTS}?${params.toString()}`;

        const res = await fetch(url, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        const txt = await res.text();
        if (!res.ok) throw new Error(txt);

        try { return JSON.parse(txt); } catch { return []; }
      }

      async function fetchMapPointsByBounds(bounds) {
        // Intento 1: campos completos (para tarjeta tipo funda)
        const selectFull = [
          "listing_id",
          "price_eur",
          "lat",
          "lng",
          "address_display",
          "useful_area_m2",
          "rooms",
          "bedrooms",
          "energy_label",
          "main_photo_url",
          "photo_url",
          "cover_url",
          "neighborhood",
          "city"
        ].join(",");

        // Fallback: mínimo (para que no se rompa aunque la vista aún no tenga esos campos)
        const selectMin = "listing_id,price_eur,lat,lng";

        try {
          return await fetchWithSelect(bounds, selectFull);
        } catch (e1) {
          try {
            return await fetchWithSelect(bounds, selectMin);
          } catch (e2) {
            throw e2;
          }
        }
      }

      function getCurrentBounds() {
        const b = map.getBounds();
        return {
          south: b.getSouthWest().lat,
          west: b.getSouthWest().lng,
          north: b.getNorthEast().lat,
          east: b.getNorthEast().lng
        };
      }

      let debounceTimer = null;

      async function loadPointsForCurrentView() {
        const b = getCurrentBounds();
        const z = map.getZoom();

        setStatus(`Cargando... (zoom ${z})`);

        const rows = await fetchMapPointsByBounds(b);

        clearMarkers();
        rows.forEach(addPoint);

        setStatus(`Anuncios en el mapa: ${rows.length} | zoom ${z}`);
      }

      function scheduleReload() {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          try {
            await loadPointsForCurrentView();
          } catch (e) {
            const msg = (e && e.message) ? e.message : String(e);
            setStatus(`Error cargando datos: ${msg}`);
            console.error(e);
          }
        }, 300);
      }

      async function geocodeCity(city) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`;
        const res = await fetch(url);
        if (!res.ok) return null;
        const data = await res.json();
        if (!data[0]) return null;
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      }

      searchBtn.addEventListener("click", async () => {
        const city = cityInput.value.trim();
        if (!city) return;

        setStatus("Buscando ciudad...");
        const center = await geocodeCity(city);
        if (center) map.setView(center, 13);

        scheduleReload();
      });

      map.on("moveend", scheduleReload);
      map.on("zoomend", scheduleReload);

      // Cerrar tarjeta si clickas el mapa (fuera de un marker)
      map.on("click", () => closeCard());

      (async () => {
        try {
          await loadPointsForCurrentView();
        } catch (e) {
          const msg = (e && e.message) ? e.message : String(e);
          setStatus(`Error cargando datos: ${msg}`);
          alert("Error al cargar datos. Revisa Supabase.");
          console.error(e);
        }
      })();
    </script>
  </body>
</html>



